name: S3 Create

on:
  workflow_dispatch: {}

env:
  AWS_REGION: us-west-2
  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

jobs:
  create_bucket:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install --update
    - name: Install jq
      run: sudo apt-get install jq

    # Steps to deploy your resources to AWS
    - name: Create S3 bucket with date and time
      run: |
        TIMESTAMP=$(date '+%Y-%m-%d-%H-%M-%S')
        BUCKET_NAME="my-s3-bucket-from-github-action-${TIMESTAMP}"
        aws s3api create-bucket --bucket "${BUCKET_NAME}" --region us-west-2 --create-bucket-configuration LocationConstraint=us-west-2
        echo "BUCKET_NAME=${BUCKET_NAME}" > bucket_name.txt
    - name: Upload bucket name as artifact
      uses: actions/upload-artifact@v2
      with:
        name: bucket-name
        path: bucket_name.txt

    - name: Set BUCKET_NAME secret
      uses: actions/github-script@v5
      with:
        script: |
          const fs = require('fs');
          const bucketName = fs.readFileSync('bucket_name.txt', 'utf8').trim();
          await github.rest.actions.createOrUpdateRepoSecret({
            owner: context.repo.owner,
            repo: context.repo.repo,
            secret_name: 'BUCKET_NAME',
            encrypted_value: bucketName,
            key_id: context.repo.key_id
          });
